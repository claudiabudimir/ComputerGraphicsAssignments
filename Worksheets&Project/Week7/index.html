<head>
    <meta name="author" content="Carlos Ventura">
    <script type="text/javascript" src="../Utilities/initShaders.js"></script>
    <script type="text/javascript" src="../Utilities/MV.js"></script>
    <script type="text/javascript" src="../Utilities/webgl-utils.js"></script>
    <meta charset="UTF-8">
    <style>
        h1,
        h2 {
            text-align: center;
        }

        body {
            background-image: url('../BG.png');
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;

            font-family: Arial;
        }

        button {
            font-weight: bold;
        }

        canvas {
            padding: 0;
            margin: auto;
            display: block;
        }

        hr.dashed {
            border-top: 3px dashed white;
        }

        ul {
            text-align: left;
            list-style-position: inside;
            font-size: larger
        }

        div {
            width: 25%;
            margin: 0 auto;
            font-weight: bolder;
            font-size: 20;
        }
    </style>
</head>

<html>

<body>
    <h2 style="text-align: center;">WORKSHEET 7: Environment Mapping and Bump Mapping</h2>
    <hr class="dashed">

    <h2>Part 1 - Cube map </h2>
    <canvas id="gl-canvas1" width="512" height="512">
        Web browser does not support HTML5’s canvas element.
    </canvas>
    <div>
        <button id="increment1">Increment</button>
        <button id="decrement1">Decrement</button>
        <button id="animation1">Animation</button>
        <br><br>

        TEXTURE FILTERING MODE - Magnification <br>
        <select id="filter-M1" style="font-size: 20;">
            <option sty value="0" >Nearest</option>
            <option value="1" selected="selected">Linear</option>
        </select>
        <br>

        TEXTURE FILTERING MODE - Minification <br>
        <select id="filter-m1" style="font-size: 20;">
            <option sty value="0">Nearest</option>
            <option value="1" selected="selected">Linear</option>
        </select>
    </div>

    <hr class="dashed">
    <h2>Part 2 - Environment</h2>
    <canvas id="gl-canvas2" width="512" height="512">
        Web browser does not support HTML5’s canvas element.
    </canvas>
    <div>
        <button id="increment2">Increment</button>
        <button id="decrement2">Decrement</button>
        <button id="animation2">Animation</button>
        <br><br>

        TEXTURE FILTERING MODE - Magnification <br>
        <select id="filter-M2" style="font-size: 20;">
            <option sty value="0" >Nearest</option>
            <option value="1" selected="selected">Linear</option>
        </select>
        <br>

        TEXTURE FILTERING MODE - Minification <br>
        <select id="filter-m2" style="font-size: 20;">
            <option sty value="0">Nearest</option>
            <option value="1" selected="selected">Linear</option>
        </select>
    </div>
    <ul>
        <li><b>QUESTION:</b>Explain the transformation.</li>
        <li><b>ANSWER:</b> The transformation can be easily explained. Let's do the matrix math. ProjectionMatrix * NodelViewMatrix * texMatrix; if texMatric is an identity matrix nothing changes.
            By making texMatrix inv_ModelViewMatrix * inv_ProjectionMatrix, the equation will be equal to the identity Matrix which is what we want because to show the quad filling the whole canvas we need to draw
        in NDC coordinates, meaning that all the matrix are identity, i.e. the final result must be an identity matrix.
        </li>
    </ul>

    <hr class="dashed">
    <h2>Part 3 - Reflection</h2>
    <canvas id="gl-canvas3" width="512" height="512">
        Web browser does not support HTML5’s canvas element.
    </canvas>
    <div>
        <button id="increment3">Increment</button>
        <button id="decrement3">Decrement</button>
        <button id="animation3">Animation</button>
        <br><br>

        TEXTURE FILTERING MODE - Magnification <br>
        <select id="filter-M3" style="font-size: 20;">
            <option sty value="0" >Nearest</option>
            <option value="1" selected="selected">Linear</option>
        </select>
        <br>

        TEXTURE FILTERING MODE - Minification <br>
        <select id="filter-m3" style="font-size: 20;">
            <option sty value="0">Nearest</option>
            <option value="1" selected="selected">Linear</option>
        </select>
    </div>

    <hr class="dashed">
    <h2>Part 4 - Bump mapping</h2>
    <canvas id="gl-canvas4" width="512" height="512">
        Web browser does not support HTML5’s canvas element.
    </canvas>
    <div>
        <button id="increment4">Increment</button>
        <button id="decrement4">Decrement</button>
        <button id="animation4">Animation</button>
        <br><br>

        TEXTURE FILTERING MODE - Magnification <br>
        <select id="filter-M4" style="font-size: 20;">
            <option sty value="0" >Nearest</option>
            <option value="1" selected="selected">Linear</option>
        </select>
        <br>

        TEXTURE FILTERING MODE - Minification <br>
        <select id="filter-m4" style="font-size: 20;">
            <option sty value="0">Nearest</option>
            <option value="1" selected="selected">Linear</option>
        </select>
    </div>

   <!--Part 1 -->

    <script id="vertex-shader-1" type="x-shader/x-vertex">
        attribute vec4 a_Position;
        attribute vec4 a_Normal; 

        varying vec4 v_Normal;

        uniform mat4 projectMatrix;
        uniform mat4 modelViewMatrix;

        void main() {

            v_Normal = a_Normal;
            gl_Position =  projectMatrix * modelViewMatrix * a_Position ;

        }
    </script>
    <script id="fragment-shader-1" type="x-shader/x-fragment">
        precision mediump float;

        varying vec4 v_Normal;

        uniform samplerCube texMap;

        void main(){

            vec4 N = normalize(v_Normal);
            gl_FragColor = textureCube(texMap, N.xyz);

        }

    </script>
    <script type="text/javascript" src="W07P1.js"></script>

   <!--Part 2 -->

    <script id="vertex-shader-2" type="x-shader/x-vertex">
        attribute vec4 a_Position;
        attribute vec4 a_Normal; 

        varying vec4 v_Normal;

        uniform mat4 projectMatrix;
        uniform mat4 modelViewMatrix;
        uniform mat4 texMatrix;

        void main() {

            v_Normal = a_Normal;
            gl_Position =  projectMatrix * modelViewMatrix * texMatrix * a_Position ;

        }

    </script>


    <script id="fragment-shader-2" type="x-shader/x-fragment">
        precision mediump float;

        varying vec4 v_Normal;

        uniform vec4 eye_Position;
        uniform samplerCube texMap;
        uniform bool reflective;

        void main(){

            vec4 N = normalize(v_Normal);
            gl_FragColor = textureCube(texMap, N.xyz);

        }


    </script>
    <script type="text/javascript" src="W07P2.js"></script>
    

   <!--Part 3 -->

    <script id="vertex-shader-3" type="x-shader/x-vertex">
        attribute vec4 a_Position;
        attribute vec4 a_Normal; 

        varying vec4 v_Normal;

        uniform mat4 projectMatrix;
        uniform mat4 modelViewMatrix;
        uniform mat4 texMatrix;

        void main() {

            v_Normal = texMatrix * a_Position; 
            gl_Position =  projectMatrix * modelViewMatrix * texMatrix * a_Position ;

        }
        

            </script>
    <script id="fragment-shader-3" type="x-shader/x-fragment">
        precision mediump float;

        varying vec4 v_Normal;

        uniform vec3 eye_Position;
        uniform samplerCube texMap;
        uniform bool reflective;

        void main(){

            vec3 N = normalize(v_Normal.xyz);

            if(reflective){
                vec3 aux = v_Normal.xyz - eye_Position;

                N = reflect(aux, v_Normal.xyz);

                
            }

            gl_FragColor = textureCube(texMap, N);

        }

            </script>
    <script type="text/javascript" src="W07P3.js"></script>

   <!--Part 4 -->

    <script id="vertex-shader-4" type="x-shader/x-vertex">
        attribute vec4 a_Position;
        attribute vec4 a_Normal; 

        varying vec4 v_Normal;

        uniform mat4 projectMatrix;
        uniform mat4 modelViewMatrix;
        uniform mat4 texMatrix;

        void main() {

            v_Normal =  texMatrix * a_Normal;
            gl_Position =  projectMatrix * modelViewMatrix * texMatrix * a_Position ;

        }

            </script>
    <script id="fragment-shader-4" type="x-shader/x-fragment">
        precision mediump float;

        varying vec4 v_Normal;

        uniform samplerCube texMap;
        uniform sampler2D bumpMap;
        uniform bool reflective;
        uniform vec3 eye_Position;

        vec3 rotate_to_normal(vec3 normal, vec3 v)
        {
          float a = 1.0/(1.0 + normal.z);
          float b = -normal.x*normal.y*a;
          return vec3(1.0 - normal.x*normal.x*a, b, -normal.x)*v.x
               + vec3(b, 1.0 - normal.y*normal.y*a, -normal.y)*v.y
               + normal*v.z;
        }

        void main(){

            vec3 N = normalize(v_Normal.xyz);

            if(reflective){

                vec3 aux = v_Normal.xyz - eye_Position;

                float pi = 3.14159265358979323846;
                float u = 1.0 - atan(N.z, N.x)/(2.0*pi);
                float v = acos(N.y)/pi;
		    
                vec2 texCoord = vec2(u,v);

                vec4 b = texture2D(bumpMap, texCoord);

                vec3 bb = normalize(2.0*b.xyz - 1.0);

                vec3 rotated = rotate_to_normal(N, bb);

                N = reflect(aux, rotated);
            }

            gl_FragColor = textureCube(texMap, N);
        }

            </script>
    <script type="text/javascript" src="W07P4.js"></script>
</body>


</html>